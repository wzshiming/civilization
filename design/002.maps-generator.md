# Maps Generator

See [000.definition.md](000.definition.md) for base type definitions.  
See [001.maps.md](001.maps.md) for base map structure definitions.

## Overview

Map generation system using Voronoi tessellation to create irregular plots with neighbor relationships, configurable projections, and extensible attributes.

## Requirements

- **Irregular Plots**: Voronoi diagram generation creates organic, non-uniform plot shapes
- **Neighbor Relationships**: Each plot tracks adjacent plots with distance and border metrics
- **Configurable Projections**: Support flat, cylindrical, and spherical map types via edge wrapping
- **Terrain Generation**: Configurable ocean percentage, continents, islands, and coastlines
- **Extensible Attributes**: Dynamic plot properties including terrain, climate, resources, and gameplay data

## Generation Algorithms

### Voronoi Generation

**Algorithm**: Fortune's Algorithm or Bowyer-Watson  
**Complexity**: O(n log n)  
**Purpose**: Generate irregular plot boundaries

### Neighbor Resolution

**Algorithm**: Delaunay triangulation as dual graph  
**Purpose**: Establish plot adjacency relationships with distance and border length metadata

### Plot Uniformity

**Algorithm**: Lloyd's relaxation (optional)  
**Purpose**: Create more evenly distributed plots

## Generation Pipeline

### Phase 1: Configuration Validation
- Validate all input parameters
- Initialize random seed
- Create MapConfig structure

### Phase 2: Seed Point Generation
- Generate random plot center points within map dimensions
- Apply optional Lloyd's relaxation for uniformity (0-10 iterations)
- Account for projection wrapping and pole scaling

### Phase 3: Voronoi Computation
- Execute Fortune's Algorithm or Bowyer-Watson
- Generate plot boundaries and vertices
- Time complexity: O(n log n)

### Phase 4: Neighbor Resolution
- Build Delaunay triangulation as dual graph
- Calculate distances between plot centers
- Calculate shared border lengths
- Apply edge wrapping for cylindrical/spherical projections

### Phase 5: Terrain Generation
- Seed initial continent centers
- Expand landmasses using breadth-first growth
- Target specified ocean percentage
- Add islands based on frequency parameter
- Apply coastal roughness

### Phase 6: Attribute Calculation
- **Altitude**: Multi-octave Perlin noise with terrain-based adjustment
- **Temperature**: Latitude-based with altitude lapse rate
- **Humidity**: Distance-to-water calculation
- **Resources**: Placement based on terrain and density settings

### Phase 7: Post-Processing
- Validate map integrity
- Serialize to output format
- Generate metadata

## Generation Parameters

### Command Line Flags

```
--plot-count=2000              # Number of plots (100-10000)
--width=1000.0                 # Map width in world units
--height=600.0                 # Map height in world units

--wrap-horizontal              # Enable horizontal wrapping (cylindrical/spherical)
--wrap-vertical                # Enable vertical wrapping (spherical)
--pole-scaling=1.5             # Size multiplier for polar regions (1.0-3.0)

--ocean-percentage=0.65        # Portion of map that is ocean (0.0-1.0)
--continent-count=3            # Number of major landmasses (1-10)
--island-frequency=0.15        # How common small islands are (0.0-1.0)
--coastal-roughness=0.5        # Coastline jaggedness (0.0-1.0)

--resource-density=0.3         # How abundant resources are (0.0-1.0)
--climate-variance=0.7         # Climate variation (0.0-1.0)

--random-seed=0                # Random seed (0 = random)
--relaxation-steps=2           # Lloyd's relaxation iterations (0-10)
```

## Performance

- **Target**: <5s for 2000 plots
- **Complexity**: O(n log n) generation, O(n) neighbor resolution
- **Memory**: ~1 MB for 2000 plots
- **Optimization**: Spatial indexing, lazy loading, caching, parallel generation

## Extensibility

Planned features: multi-layer maps (surface/underground/space), dynamic terrain changes, advanced resource mechanics, climate systems, map editor.

## Testing

- **Unit**: Voronoi generation, neighbor validation, edge wrapping, attributes
- **Integration**: Full pipeline, projections, terrain distribution
- **Performance**: Generation time, memory usage, scalability
- **Quality**: Symmetric neighbors, ocean percentage ±5%, valid attributes

## References

Fortune's Algorithm, Bowyer-Watson, Lloyd's relaxation, Perlin/Simplex noise. See Civilization V/VI, Crusader Kings, Dwarf Fortress, Red Blob Games.

## Attribute Calculation

### Temperature
- Base: 30°C at equator, -10°C at poles
- Altitude lapse rate: -0.0065°C per meter
- Noise variation: ±5°C

### Humidity
- Inverse distance to water (100 world units characteristic distance)
- Terrain modifiers: jungle +0.3, desert -0.3
- Clamped to 0.0-1.0

### Altitude
- Multi-octave Perlin noise (5 octaves)
- Range: -4000m (ocean floor) to 12000m (mountains)
- Terrain-based refinement applied
